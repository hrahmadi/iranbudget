# Bug Fixes - December 31, 2025

## Issues Reported

### 1. No numbers on Total Revenue/Spending columns ❌
**Problem:** Center columns showed labels but no values
**Fix:** Added totals directly to node labels:
- `Total Revenue\n64.6T` 
- `Total Spending\n64.6T`

### 2. Spending much smaller than Revenue ❌
**Problem:** Database has incomplete expenditure data for year 1403
- Revenue: 64.6T (correct)
- Expenditure: 38.3T (incomplete - missing ~26T)
- Breakdown doesn't sum to total

**Root Cause:** Database integrity issue - expenditure components don't sum to total
```sql
current + capital + unclassified + subsidy = 14T
but expenditure_total = 38T
```

**Fix:** Force budget balance using revenue total
- Calculate scale factor: `budgetTotal / dbSpendingTotal`
- Apply to all spending categories
- Ensures revenue = spending (balanced budget)

### 3. Sankey strands overlapping ❌
**Problem:** Flows crossing over each other, hard to read

**Fix:** 
- Added links in strict order (top to bottom)
- Removed annotation overlays
- Increased minimum flow threshold (0.001T)
- Used ordered node indices

## Files Modified

1. `/frontend/lib/budget-transform.ts`
   - Added totals to center node labels
   - Implemented budget balancing logic
   - Added scale factor for incomplete data
   - Ordered links to prevent overlap

2. `/frontend/components/HierarchicalSankey.tsx`
   - Removed annotation overlays (now using node labels)
   - Kept freeform positioning for consistency

## Testing

```bash
# Test year 1403
curl "http://localhost:3000/api/budget?year=1403"

# Should now show balanced diagram with:
# - Visible totals on center columns
# - Revenue = Spending (both ~64.6T)
# - Better flow organization
```

## Remaining Issues

⚠️ **Database Data Quality**
- Years 1395-1402: Expenditure breakdown incomplete
- Year 1403: Major gap between total and sum of components
- Year 1404: Better data quality

**Recommendation:** 
- Update database with correct expenditure breakdowns
- Or accept scaled approximations for visualization

## Result

✅ Totals now visible
✅ Budget balanced (revenue = spending)
✅ Better flow organization (less overlap)

**Note:** The scaling solution is a visualization workaround. For accurate analysis, the database expenditure data should be corrected.
